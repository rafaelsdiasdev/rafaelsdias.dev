---
import { SITE_TITLE } from '../consts';
import HeaderLink from './HeaderLink.astro';
---

<header class="header">
	<nav class="nav">
		<h2 class="text-xl font-bold">
			<a href={import.meta.env.BASE_URL} class="text-purple-600 hover:text-purple-800 transition-colors no-underline">
				{SITE_TITLE}
			</a>
		</h2>
		
		<div class="nav-links">
			<HeaderLink href={import.meta.env.BASE_URL}>Home</HeaderLink>
			<HeaderLink href={import.meta.env.BASE_URL + 'blog/'}>Blog</HeaderLink>
			<HeaderLink href={import.meta.env.BASE_URL + 'about/'}>Sobre</HeaderLink>
		</div>
		
		<div class="search-container">
			<div class="search-wrapper">
				<input 
					type="search" 
					id="search-input" 
					placeholder="Buscar artigos..."
					class="search-input"
					autocomplete="off"
				/>
				<button class="search-button" aria-label="Buscar">
					<svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
						<path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
					</svg>
				</button>
				
				<!-- Modal de resultados -->
				<div id="search-modal" class="search-modal hidden">
					<div class="search-modal-content">
						<div id="search-modal-stats" class="search-modal-stats hidden"></div>
						<div id="search-modal-results" class="search-modal-results"></div>
						<div id="search-modal-no-results" class="search-modal-no-results hidden">
							<p>Nenhum resultado encontrado</p>
							<a href={`${import.meta.env.BASE_URL}search/`} class="search-modal-link">Ver página de busca</a>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<div class="social-links">
			<button id="theme-toggle" class="theme-toggle" aria-label="Alternar tema">
				<svg class="sun-icon" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
					<path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>
				</svg>
				<svg class="moon-icon" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
					<path d="M12.1 22c-5.5 0-10-4.5-10-10 0-5.6 4.5-10 10-10 1.8 0 3.5.5 4.9 1.3.4.2.6.7.4 1.1-.2.4-.7.6-1.1.4-1-.6-2.2-.9-3.4-.9-3.9 0-7 3.1-7 7s3.1 7 7 7c2.4 0 4.7-1.2 6-3.2.2-.4.7-.5 1.1-.3.4.2.5.7.3 1.1-1.7 2.9-4.8 4.6-8.2 4.6z"/>
				</svg>
			</button>
			
			<a 
				href="https://www.linkedin.com/in/rafaelsdiasdev/" 
				target="_blank"
				aria-label="LinkedIn do Rafael"
			>
				<svg viewBox="0 0 16 16" aria-hidden="true" width="24" height="24" class="fill-current">
					<path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"/>
				</svg>
			</a>
			<a 
				href="https://github.com/rafaelsdiasdev" 
				target="_blank"
				aria-label="GitHub do Rafael"
			>
				<svg viewBox="0 0 16 16" aria-hidden="true" width="24" height="24" class="fill-current">
					<path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
				</svg>
			</a>
		</div>
	</nav>
</header>

<script>
// Theme toggle functionality
const themeToggle = document.getElementById('theme-toggle');
const html = document.documentElement;

// Check for saved theme preference or default to dark mode
const currentTheme = localStorage.getItem('theme') || 'dark';
html.setAttribute('data-theme', currentTheme);

themeToggle?.addEventListener('click', () => {
	const currentTheme = html.getAttribute('data-theme');
	const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
	
	html.setAttribute('data-theme', newTheme);
	localStorage.setItem('theme', newTheme);
});

// Search modal functionality
document.addEventListener('DOMContentLoaded', async () => {
	const searchInput = document.getElementById('search-input');
	const searchModal = document.getElementById('search-modal');
	const modalStats = document.getElementById('search-modal-stats');
	const modalResults = document.getElementById('search-modal-results');
	const modalNoResults = document.getElementById('search-modal-no-results');

	// Carregar dados dos posts via API
	let searchData = [];
	
	try {
		const response = await fetch(`${import.meta.env.BASE_URL}api/posts.json`);
		if (response.ok) {
			searchData = await response.json();
		}
	} catch (error) {
		// Fallback silencioso - busca simplesmente não funcionará
		searchData = [];
	}

	// Função de busca
	function searchPosts(query) {
		if (!query || query.length < 2) {
			hideModal();
			return;
		}

		const lowerQuery = query.toLowerCase();
		const results = searchData.filter(post => 
			post.title.toLowerCase().includes(lowerQuery) ||
			post.description.toLowerCase().includes(lowerQuery)
		).slice(0, 5); // Limitar a 5 resultados no modal

		showModal(results, query);
	}

	// Mostrar modal com resultados
	function showModal(results, query) {
		if (results.length === 0) {
			showNoResults();
			return;
		}

		// Mostrar estatísticas
		modalStats.textContent = `${results.length} resultado${results.length !== 1 ? 's' : ''} encontrado${results.length !== 1 ? 's' : ''}`;
		modalStats.classList.remove('hidden');

		// Mostrar resultados
		modalResults.innerHTML = results.map(post => `
			<a href="${post.url}" class="search-modal-item">
				<div class="search-modal-item-title">
					${highlightText(post.title, query)}
				</div>
				<div class="search-modal-item-desc">
					${highlightText(truncateText(post.description, 100), query)}
				</div>
				<div class="search-modal-item-date">
					${formatDate(post.pubDate)}
				</div>
			</a>
		`).join('');

		modalResults.classList.remove('hidden');
		modalNoResults.classList.add('hidden');
		searchModal.classList.remove('hidden');
	}

	// Mostrar quando não há resultados
	function showNoResults() {
		modalStats?.classList.add('hidden');
		modalResults?.classList.add('hidden');
		modalNoResults?.classList.remove('hidden');
		searchModal?.classList.remove('hidden');
	}

	// Esconder modal
	function hideModal() {
		searchModal?.classList.add('hidden');
	}

	// Destacar texto da busca
	function highlightText(text, query) {
		if (!query) return text;
		const regex = new RegExp(`(${query})`, 'gi');
		return text.replace(regex, '<mark>$1</mark>');
	}

	// Truncar texto
	function truncateText(text, maxLength) {
		if (text.length <= maxLength) return text;
		return text.substring(0, maxLength) + '...';
	}

	// Formatar data
	function formatDate(dateString) {
		return new Date(dateString).toLocaleDateString('pt-BR', {
			day: 'numeric',
			month: 'short',
			year: 'numeric'
		});
	}

	// Event listeners
	searchInput?.addEventListener('input', (e) => {
		const target = e.target as HTMLInputElement;
		searchPosts(target.value);
	});

	searchInput?.addEventListener('focus', (e) => {
		const target = e.target as HTMLInputElement;
		if (target.value.length >= 2) {
			searchPosts(target.value);
		}
	});

	// Fechar modal ao clicar fora
	document.addEventListener('click', (e) => {
		const target = e.target as HTMLElement;
		if (target && !target.closest('.search-container')) {
			hideModal();
		}
	});

	// Fechar modal ao pressionar Escape
	document.addEventListener('keydown', (e) => {
		if (e.key === 'Escape') {
			hideModal();
		}
	});
});
</script>
